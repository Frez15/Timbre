<script>
    // Obtener referencias a elementos del DOM
    const mainSection = document.getElementById('main-section');
    const intercomSection = document.getElementById('intercom-section');
    const intercomTitle = document.getElementById('intercom-title');
    const ringButton = document.getElementById('ring-button');
    const backButton = document.getElementById('back-button');
    const feedbackMessage = document.getElementById('feedback-message');
    const appMessageDiv = document.getElementById('app-message');
    const loader = document.getElementById('loader');

    // Manejar clics en los timbres
    const timbreElements = document.querySelectorAll('.timbre');
    timbreElements.forEach(timbre => {
        timbre.addEventListener('click', () => {
            const timbreId = timbre.getAttribute('data-timbre');
            console.log(`Timbre clicado: ${timbreId}`); // Debug

            // Extraer piso y departamento del timbreId
            const floor = getFloor(timbreId);
            const apartment = getApartment(timbreId);

            // Actualizar el título del intercom con piso y departamento
            intercomTitle.innerText = `Timbre ${floor} ${apartment}`;

            // Guardar el ID del timbre seleccionado
            intercomSection.setAttribute('data-timbre-id', timbreId);

            // Ocultar la sección principal y mostrar la sección de intercom
            mainSection.classList.add('hidden');
            intercomSection.classList.add('active');

            // Limpiar mensajes anteriores y mostrar "Esperando respuesta"
            feedbackMessage.innerText = '';
            appMessageDiv.innerText = 'Esperando respuesta'; // Mostrar "Esperando respuesta" al iniciar la solicitud
            document.getElementById('name').value = '';

            // Crear el mensaje pendiente en la base de datos
            const sender = 'Remitente'; // Debes reemplazar esto con la identificación real del remitente
            const receiver = 'Receptor'; // Debes reemplazar esto con la identificación real del receptor

            const messageBody = {
                floor: floor, // Asegúrate de que sea String
                apartment: apartment,
                sender: sender,
                receiver: receiver,
                message: 'Alguien ha presionado el timbre.',
            };

            fetch('/api/create-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(messageBody),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al crear el mensaje pendiente.');
                }
                return response.json();
            })
            .then(data => {
                console.log('Mensaje pendiente creado:', data);
                // Opcional: Puedes almacenar el ID del mensaje si lo necesitas
            })
            .catch(error => {
                console.error('Error al crear el mensaje pendiente:', error);
                feedbackMessage.innerText = 'Error al iniciar la comunicación.';
                feedbackMessage.classList.add('error');
            });

            // Obtener el mensaje desde la app para este timbre
            fetch(`/api/get-message?floor=${encodeURIComponent(floor)}&apartment=${encodeURIComponent(apartment)}`)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('No hay mensajes desde la app.');
                        } else {
                            throw new Error('Error al obtener el mensaje desde la app.');
                        }
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.message) {
                        appMessageDiv.innerText = data.message;
                    } else {
                        appMessageDiv.innerText = 'No hay mensajes desde la app.';
                    }
                })
                .catch(error => {
                    console.error('Error al obtener el mensaje desde la app:', error);
                    appMessageDiv.innerText = error.message;
                });
        });
    });

    // Manejar clic en el botón VOLVER
    backButton.addEventListener('click', () => {
        console.log('Botón Volver clicado'); // Debug
        intercomSection.classList.remove('active');
        mainSection.classList.remove('hidden');
        feedbackMessage.innerText = '';

        // Obtener el ID del timbre seleccionado
        const timbreId = intercomSection.getAttribute('data-timbre-id');
        const floor = getFloor(timbreId);
        const apartment = getApartment(timbreId);

        // Eliminar el mensaje pendiente
        fetch('/api/delete-message', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ floor, apartment }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al eliminar el mensaje pendiente.');
            }
            return response.json();
        })
        .then(data => {
            console.log('Mensaje pendiente eliminado:', data);
        })
        .catch(error => {
            console.error('Error al eliminar el mensaje pendiente:', error);
            // Opcional: Mostrar un mensaje de error al usuario
        });
    });

    // Manejar clic en el botón TOCAR
    ringButton.addEventListener('click', () => {
        console.log('Botón TOCAR clicado'); // Debug
        const timbreId = intercomSection.getAttribute('data-timbre-id');
        const name = document.getElementById('name').value.trim();

        // Extraer piso y departamento del timbreId
        let floor;
        let apartment;

        if (timbreId.startsWith('E')) {
            floor = 'Encargado';
            apartment = 'Encargado';
        } else {
            const parts = timbreId.split('-');
            floor = parts[0];
            apartment = parts[1];
        }

        // Validar datos
        if (!floor || !apartment) {
            feedbackMessage.innerText = 'No se puede enviar notificación al encargado.';
            feedbackMessage.classList.remove('success');
            feedbackMessage.classList.add('error');
            console.log('Error: Faltan piso o departamento'); // Debug
            return;
        }

        // Preparar el cuerpo de la solicitud
        const requestBody = {
            floor: floor, // Asegúrate de enviar como String
            apartment: apartment,
            title: `Timbre ${floor}-${apartment} Presionado`,
            body: name ? `${name} ha presionado el timbre.` : 'Alguien ha presionado el timbre.'
        };

        console.log('Enviando solicitud:', requestBody); // Debug

        // Mostrar loader
        loader.style.display = 'block';
        feedbackMessage.innerText = '';
        
        // Enviar la solicitud al backend
        fetch('/api/notify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody),
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => {
                    throw new Error(errData.message || 'Error al enviar la notificación.');
                });
            }
            return response.json();
        })
        .then(data => {
            // Ocultar loader
            loader.style.display = 'none';
            console.log('Respuesta del servidor:', data); // Debug
            if (data.message === 'Notificación enviada exitosamente.') {
                feedbackMessage.innerText = 'Notificación enviada correctamente.';
                feedbackMessage.classList.remove('error');
                feedbackMessage.classList.add('success');
                // Opcional: redirigir de vuelta después de un tiempo
                setTimeout(() => {
                    backButton.click();
                }, 2000);
            } else {
                feedbackMessage.innerText = `Error: ${data.message}`;
                feedbackMessage.classList.remove('success');
                feedbackMessage.classList.add('error');
            }
        })
        .catch(error => {
            // Ocultar loader
            loader.style.display = 'none';
            console.error('Error al enviar la notificación:', error);
            feedbackMessage.innerText = `Error: ${error.message}`;
            feedbackMessage.classList.remove('success');
            feedbackMessage.classList.add('error');
        });
    });

    // Funciones auxiliares para extraer piso y departamento
    function getFloor(timbreId) {
        if (timbreId.startsWith('E')) return 'Encargado';
        if (timbreId.startsWith('PB-')) return 'PB';
        const match = timbreId.match(/^(\d+)-/);
        return match ? match[1] : '';
    }

    function getApartment(timbreId) {
        if (timbreId.startsWith('E')) return 'Encargado';
        const match = timbreId.match(/-(.+)$/);
        return match ? match[1] : '';
    }
</script>
